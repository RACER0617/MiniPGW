# MiniPGW — Выпускная работа C++ школы

**MiniPGW** — это упрощённая реализация компонента Packet Gateway (PGW), написанная на C++ для Linux. Она имитирует базовую функциональность PGW, обрабатывая UDP-запросы, управляя сессиями абонентов на основе IMSI (International Mobile Subscriber Identity), ведя журнал Call Detail Record (CDR), предоставляя HTTP API, поддерживая чёрный список IMSI и обеспечивая плавное завершение работы. Проект состоит из серверного приложения (`pgw_server`), клиентского приложения (`pgw_client`) и набора тестов.

---

## Особенности

### Сервер (`pgw_server`)
- Прослушивает UDP-запросы, содержащие IMSI в формате BCD (Binary-Coded Decimal).
- Создаёт или отклоняет сессии абонентов на основе настраиваемого чёрного списка.
- Управляет сессиями с настраиваемыми таймаутами.
- Записывает события сессий (создание, удаление, завершение) в файл CDR.
- Предоставляет HTTP API для проверки статуса абонента и инициирования завершения работы.

### Клиент (`pgw_client`)
- Отправляет UDP-запросы с указанным IMSI на сервер.
- Получает и отображает ответ сервера (например, "created" или "rejected").

### Утилиты
- Загружает конфигурации сервера и клиента из JSON-файлов.
- Конвертирует IMSI между строковым и BCD форматами.

### Тестирование
- Модульные тесты для утилит (конвертация IMSI-BCD, загрузка конфигурации).
- Интеграционные тесты для взаимодействия клиента и сервера.

### Логирование
- Использует `spdlog` для настраиваемого логирования как в консоль, так и в файлы (`pgw.log`, `client.log`).
- Поддерживает уровни `INFO` и `DEBUG`, с возможностью включения режима отладки.

---

## Требования

- **Linux** среда.
- **CMake** (версия 3.16 или выше).
- **C++17**-совместимый компилятор (например, GCC).
- **Зависимости** (автоматически управляются через CMake):
  - `nlohmann_json` (парсинг JSON, устанавливается через системный менеджер пакетов).
  - `cpp-httplib` (HTTP-сервер, загружается через CMake).
  - `spdlog` (логирование, загружается через CMake).
  - `googletest` (фреймворк для тестирования, загружается через CMake).

---

## Структура проекта

- **`CMakeLists.txt`**: Корневой файл конфигурации CMake.
- **`config_server.json`**: Файл конфигурации сервера.
- **`config_client.json`**: Файл конфигурации клиента.
- **`src/common/`**: Общие утилиты (загрузка конфигурации, конвертация IMSI).
- **`src/server/`**: Исходный код серверного приложения.
- **`src/client/`**: Исходный код клиентского приложения.
- **`tests/`**: Модульные и интеграционные тесты.

---

## Сборка проекта

1. Создайте директорию для сборки и перейдите в неё:
   ```bash
   mkdir build && cd build
   ```
2. Настройте проект с помощью CMake:
   ```bash
   cmake ..
   ```
3. Скомпилируйте проект:
   ```bash
   make
   ```

Это сгенерирует исполняемые файлы `pgw_server`, `pgw_client` и тестовые бинарники в директории `build`.

---

## Запуск сервера

Запустите сервер с файлом конфигурации:

```bash
./src/server/pgw_server ../config_server.json [debug]
```

- **`../config_server.json`**: Путь к файлу конфигурации сервера.
- **`[debug]`**: Опциональный флаг для включения отладочного логирования (по умолчанию `INFO`).

### Пример `config_server.json`
```json
{
  "udp_ip": "0.0.0.0",
  "udp_port": 9000,
  "session_timeout_sec": 30,
  "cdr_file": "cdr.log",
  "http_port": 8080,
  "graceful_shutdown_rate": 10,
  "log_file": "pgw.log",
  "log_level": "INFO",
  "blacklist": ["001010123456789", "001010000000001"]
}
```

---

## Запуск клиента

Отправьте UDP-запрос на сервер с указанным IMSI:

```bash
./src/client/pgw_client ../config_client.json <IMSI> [debug]
```

- **`../config_client.json`**: Путь к файлу конфигурации клиента.
- **`<IMSI>`**: 15-значный IMSI (например, `001010123456789`).
- **`[debug]`**: Опциональный флаг для включения отладочного логирования.

### Пример `config_client.json`
```json
{
  "server_ip": "127.0.0.1",
  "server_port": 9000,
  "log_file": "client.log",
  "log_level": "INFO"
}
```

---

## Использование HTTP API

Сервер предоставляет два HTTP эндпоинта:

1. **Проверка статуса абонента**:
   ```bash
   curl http://localhost:8080/check_subscriber?imsi=<IMSI>
   ```
   - Возвращает `"active"`, если у IMSI есть активная сессия, `"not active"` в противном случае.
   - Пример: `curl http://localhost:8080/check_subscriber?imsi=001010123456789`

2. **Плавное завершение работы**:
   ```bash
   curl http://localhost:8080/stop
   ```
   - Инициирует завершение работы сервера, удаляя сессии с заданной скоростью (например, 10 сессий/сек).

---

## Запуск тестов

Проект включает модульные и интеграционные тесты в директории `tests/`. После сборки запустите их вручную:

```bash
./tests/test_utils           # Тесты конвертации IMSI-BCD
./tests/test_config          # Тесты загрузки конфигурации
./tests/test_client_integration  # Тесты UDP-взаимодействия клиента
./tests/test_server_integration  # Тесты декодирования BCD на сервере
```

Или используйте `ctest` для автоматического выполнения (из директории `build`):

```bash
ctest
```

---

## Логирование

- **Логи сервера**: Записываются в `pgw.log` (настраивается в `config_server.json`).
- **Логи клиента**: Записываются в `client.log` (настраивается в `config_client.json`).
- Отладочное логирование включается с флагом `[debug]`; в противном случае в консоль выводятся только сообщения уровня `INFO` и выше.

---

## Плавное завершение работы

Сервер поддерживает управляемое завершение:
- Запускается через `curl http://localhost:8080/stop`.
- Сессии удаляются с заданной скоростью (например, 10 сессий/сек), указанной в `graceful_shutdown_rate`.
- События записываются в файл CDR (например, `cdr.log`).

---

Автор: Морохия Астан, IT-Школа ПРОТЕЙ, ст. ГУАП
